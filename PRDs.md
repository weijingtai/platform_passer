### PRDs.md

---

### 概要
**目标**：设计并实现一款跨平台（Windows / macOS（含 Apple Silicon） / Linux）键盘与鼠标共享应用，支持**键鼠共享、剪贴板同步、文件拖拽/传输、以及多显示器无缝切换**，以低延迟、高安全性和可维护性为核心指标。  
**愿景**：提供比现有 Synergy/ShareMouse/Barrier 更稳定、对现代操作系统友好的解决方案，适用于个人与企业场景。

---

### 范围（Scope）
- **包含**：跨平台客户端与主控端、加密认证的点对点/局域网通信、事件捕获与注入、剪贴板同步（文本/图片/文件引用）、文件传输（分块、断点续传）、显示器布局同步与鼠标跨屏逻辑、权限引导与诊断工具、日志与崩溃回退策略。  
- **不包含（初始版本）**：内核级驱动（除非必要）、远程桌面功能、复杂的企业集中管理控制台（可作为后续版本）。

---

### 关键成功指标（KPIs）
- **输入延迟**（本地局域网）：目标 \< 20 ms 平均端到端延迟。  
- **剪贴板同步成功率**：> 99%（文本/图片）。  
- **文件传输吞吐**：在千兆局域网下达到接近网络带宽的利用率（受磁盘限制）。  
- **稳定性**：24 小时无崩溃运行率 > 99.9%。  
- **权限/安装成功率**：首次安装并完成必要权限引导的用户占比 > 95%。

---

### 用户画像与场景
- **单人多机办公**：开发者/设计师在多台机器间无缝切换键鼠与剪贴板。  
- **混合平台团队**：Windows 与 macOS 混合环境下共享外设。  
- **演示/会议场景**：快速在多台机器间切换控制权并传输文件。  

---

### 产品需求（功能性需求）

#### 1. 核心功能
- **键鼠共享**  
  - **捕获**：主机捕获本地键盘与鼠标事件（支持多键、组合键、鼠标滚轮、按键长按）。  
  - **编码与传输**：事件序列化、压缩（可选）、通过加密通道发送。  
  - **注入**：客户端在目标平台上注入事件，保持原始按键/修饰键语义。  
- **剪贴板同步**  
  - 文本、富文本、图片（PNG/JPEG）、文件路径/引用。  
  - 冲突解决策略（最近一次/用户确认）。  
- **文件传输**  
  - 文件拖拽触发传输或通过 UI 选择文件。  
  - 支持分块、校验、断点续传、并行流。  
- **多显示器支持**  
  - 自动检测显示器布局（坐标系），计算鼠标跨屏边界并切换目标主机。  
  - 支持不同 DPI / 缩放设置的坐标映射。  
- **连接管理**  
  - 自动发现（mDNS/UDP 广播）与手动配对（二维码/短码）。  
  - 会话加密与认证（mTLS 或基于证书的 QUIC）。  
- **权限与引导**  
  - 平台特定权限引导（macOS Accessibility/Input Monitoring、Windows 安全提示、Linux udev 规则）。  
  - 权限检测与诊断页面。  

#### 2. 管理与可观测性
- **日志**：分级日志（info/warn/error），本地与可选远程上传（用户同意）。  
- **崩溃回退**：守护进程/launcher 实现指数退避重启与崩溃原因上报。  
- **版本与更新**：内置更新检查（可选），支持差分更新。  

---

### 非功能性需求（NFR）
- **性能**：低延迟、低 CPU 占用、内存占用受控。  
- **安全**：默认启用端到端加密、最小权限原则、可审计的事件日志。  
- **可维护性**：模块化代码、清晰的跨平台抽象层、自动化测试覆盖。  
- **可扩展性**：协议支持扩展字段与版本协商。  
- **可用性**：清晰的安装与权限引导、错误提示与恢复建议。  

---

### 技术选型与理由（详细对比）

#### 语言与核心运行时
| 选项 | 优点 | 缺点 | 推荐理由 |
|---|---|---|---|
| **Rust** | 性能接近 C/C++；内存安全；优秀并发生态（tokio）；良好跨平台支持 | 学习曲线；部分平台绑定需手工维护 | **推荐**：安全 + 性能 + 生态（quinn/tokio）最匹配需求 |
| C++ | 生态成熟；大量现成库 | 内存安全风险；构建复杂 | 备选（若需大量现有 C++ 代码复用） |
| Go | 开发速度快；网络库好 | 对系统级 API 调用不如 Rust/C++ 灵活；CGEvent 等绑定较少 | 不推荐为核心语言，但可用于工具/后台服务 |

#### 网络层
| 选项 | 优点 | 缺点 | 推荐理由 |
|---|---|---|---|
| **QUIC（quinn）** | 低延迟、支持多路复用、连接迁移、内置 TLS1.3 | 实现复杂度高于 TCP | **推荐**：实时输入场景对延迟与连接稳定性要求高 |
| TCP + TLS | 实现简单、兼容性好 | 头阻塞、连接迁移差 | 作为 fallback 可用 |
| WebRTC DataChannel | NAT 穿透好 | 复杂、依赖浏览器/堆栈 | 可作为 P2P 穿透备选，不作为首选 |

#### 平台输入注入（macOS）
| 选项 | 优点 | 缺点 | 推荐理由 |
|---|---|---|---|
| **CGEventPost / CoreGraphics** | 官方 API，能注入键鼠事件 | 受 Input Monitoring / Accessibility 权限限制；在某些系统版本需额外处理 | **推荐**：首选注入方式；配合权限引导与守护进程使用 |
| DriverKit / 内核扩展 | 更底层、可能绕过部分限制 | 复杂、签名/Notarization 要求高、审核严格 | 仅在 CGEventPost 无法满足时作为补充方案 |

#### 平台输入注入（Windows）
| 选项 | 优点 | 缺点 | 推荐理由 |
|---|---|---|---|
| **SendInput / Raw Input（windows crate）** | 官方、稳定 | 需要处理焦点与安全软件拦截 | **推荐**：首选，使用 windows crate 绑定 |
| 内核驱动 | 更强控制 | 开发与签名成本高 | 仅在特殊场景下考虑 |

#### Linux 注入
- **uinput + evdev**：主流方案，适用于 X11；Wayland 需 compositor 支持或使用 XWayland 兼容层。  
- **Wayland**：多数 compositor 禁止注入，需 compositor 插件或用户授权的扩展。  
**策略**：实现 uinput + XWayland fallback，并提供 compositor-specific 插件接口。

---

### 协议与数据格式（概要）
- **传输层**：QUIC + TLS（mTLS 可选）  
- **消息模型**：二进制帧（frame）+ 帧类型（Event、Clipboard、FileMeta、FileChunk、Control）  
- **事件格式（示例）**：  
  - **KeyboardEvent**: `{timestamp:u64, device_id:u32, key_code:u16, modifiers:u8, action:u8}`  
  - **MouseEvent**: `{timestamp:u64, x:float, y:float, button_mask:u8, wheel:int16}`  
- **版本与协商**：每次连接包含协议版本号与能力位掩码（capabilities bitmask）以支持向后兼容。  

---

### 权限、安装与用户引导
- **macOS**：引导用户打开 Accessibility 与 Input Monitoring；提供一键打开“系统设置”链接与图文说明；建议使用 per-user agent（LaunchAgent）而非 root daemon，以避免权限与注入限制。  
- **Windows**：提示用户以管理员或普通用户安装；处理 UAC 场景；提供驱动/签名说明（若使用驱动）。  
- **Linux**：提供 udev 规则安装脚本与说明；检测 Wayland/X11 并提示兼容性。  

---

### 可能遇到的问题与解决方案（详尽）

#### 问题：macOS 上“重复启动 / 崩溃循环”
- **原因**：权限拒绝导致关键模块抛异常；守护进程检测到子进程退出并立即重启（无退避）；未处理的异常或内存访问错误。  
- **解决方案**：  
  - **守护策略**：实现指数退避（exponential backoff）与最大重试次数；在重启前记录崩溃堆栈并提示用户。  
  - **权限检测**：启动时先检测必要权限，若缺失则进入“权限引导模式”，不启动注入模块。  
  - **隔离进程**：将注入逻辑放在单独进程，主进程负责 UI 与权限引导，避免整个应用因注入失败崩溃。  
  - **崩溃上报**：本地保存崩溃日志并在用户允许下上传以便诊断。  

#### 问题：Wayland 下无法注入
- **原因**：Wayland 设计禁止或限制输入注入。  
- **解决方案**：  
  - 提供 XWayland fallback；  
  - 提供 compositor-specific 插件或扩展（例如 GNOME Shell extension）并提供安装说明；  
  - 在 UI 中明确告知用户功能限制并提供替代方案（例如远程桌面）。  

#### 问题：安全与滥用（恶意注入）
- **风险**：应用若被滥用可用于远程控制用户设备。  
- **缓解**：  
  - **强认证**：默认使用 mTLS 或基于证书的配对；首次配对需本地确认（短码/二维码）。  
  - **最小权限**：仅在用户明确授权后启用注入；提供显著的 UI 提示当前被远程控制。  
  - **审计日志**：记录关键操作（配对、权限变更、远程控制会话）并允许用户查看。  
  - **安全审计**：代码审计与第三方安全评估（尤其是注入与网络模块）。  

#### 问题：剪贴板冲突或数据丢失
- **原因**：并发修改、格式不兼容、传输失败。  
- **解决方案**：  
  - 使用事务式同步（先发送元信息，再发送数据）；  
  - 冲突策略：最近一次覆盖或弹出选择（可配置）；  
  - 对大对象（图片/文件）使用分块与校验。  

#### 问题：文件拖拽跨平台语义差异
- **原因**：不同平台拖拽 API 与权限模型不同。  
- **解决方案**：统一为“拖拽触发元事件 + 文件传输协议”，在目标端以本地临时文件或虚拟文件句柄呈现。  

---

### 测试计划
- **单元测试**：协议序列化/反序列化、事件编码/解码、权限检测逻辑。  
- **集成测试**：跨平台事件流（Windows↔macOS↔Linux）在局域网环境下的端到端测试。  
- **性能测试**：延迟基准、并发文件传输吞吐、CPU/内存占用。  
- **兼容性测试**：macOS 各主流版本（含 Apple Silicon）、Windows 10/11、主流 Linux 发行版与 Wayland/X11。  
- **安全测试**：渗透测试、权限滥用场景、证书与密钥管理测试。  

---

### 部署与发布策略
- **签名与 Notarization（macOS）**：必须进行 Apple 签名与 notarization，确保用户可顺利授予权限。  
- **Windows 签名**：代码签名证书以减少安全软件误报。  
- **Linux 包**：提供 DEB/RPM 与通用 tarball，并提供 udev 安装脚本。  
- **更新机制**：可选内置更新（差分），或通过包管理器/商店发布。  

---

### 风险清单与缓解（优先级排序）
1. **macOS 注入受限导致核心功能不可用** — 缓解：权限引导、DriverKit 备选、明确用户提示。  
2. **Wayland 不可注入** — 缓解：XWayland fallback、compositor 插件。  
3. **安全滥用** — 缓解：强认证、用户确认、审计日志。  
4. **崩溃循环/重复启动** — 缓解：守护退避、隔离进程、崩溃日志。  
5. **跨平台坐标映射错误（DPI/缩放）** — 缓解：显示器元数据同步、缩放转换测试。  

---

### 里程碑与时间线（建议 MVP 路线）
- **M0（2 周）**：需求确认、协议草案、项目骨架（Rust + tokio + quinn）。  
- **M1（6 周）**：实现局域网自动发现、基本键鼠事件捕获（主机）与回放（本地回放模拟）。  
- **M2（8 周）**：实现跨主机事件传输（QUIC）、Windows 注入与 macOS 基本注入（权限引导）。  
- **M3（6 周）**：剪贴板同步与文件传输基础（分块、校验）。  
- **M4（6 周）**：多显示器支持、坐标映射、稳定性优化。  
- **M5（4 周）**：兼容性测试、签名/Notarization、Beta 发布。  

---

### 交付物（MVP）
- 跨平台二进制（Windows/macOS/Linux）或安装包。  
- 文档：安装与权限引导、用户手册、开发者协议文档（事件格式）。  
- 自动化测试套件与基准测试结果。  
- 崩溃与日志收集工具（本地）。  

---

### 附录 A：模块化架构建议
- **core/**：协议、会话管理、加密、剪贴板逻辑、文件传输引擎。  
- **platform/**：平台适配层（windows/, macos/, linux/），包含捕获与注入实现。  
- **ui/**：安装/权限引导、设置、日志查看。  
- **agent/**：可选守护进程/launcher，负责进程管理与权限检测。  

---

### 附录 B：安全与隐私要点
- **默认不开启远程控制**：必须显式配对并授权。  
- **密钥管理**：使用操作系统安全存储（Keychain / Windows Credential Manager / libsecret）。  
- **最小化数据收集**：仅在用户同意下上传崩溃/诊断数据。  

---

我可以接着把**通信协议（frame 定义、序列化示例、版本协商流程）写成 RFC 风格草案**并生成对应的 Rust 类型定义与序列化示例代码，作为下一步交付。


跨平台键鼠共享应用需求文档 (PRD)
1. 项目概要
目标：设计并实现一款非商用的跨平台（Windows / macOS）键鼠共享应用。

核心功能：键鼠共享、剪贴板同步、文件拖拽传输、延迟实时监控。

愿景：通过 Rust 与 QUIC 协议提供极低延迟、高安全性的免费开源解决方案。

2. 范围 (Scope)
包含：

Windows (10/11) 与 macOS (Intel/Apple Silicon) 客户端。

基于 QUIC 的加密点对点通信。

实时延迟探测与可视化反馈。

系统级操作通知（连接、传输、错误）。

不包含：Linux 支持、移动端（iOS/Android）、内核级驱动开发（初始阶段）、商业化付费模块。

3. 产品需求 (Functional Requirements)
3.1 核心连接与注入
事件捕获与注入：

Windows：使用 SendInput API 进行事件注入。需识别 UAC 界面状态，当无法注入时及时反馈。

macOS：使用 CGEventPost，需引导用户开启“辅助功能”与“输入监听”权限。

文件传输：仅支持拖拽触发。通过 QUIC 流进行文件分块传输，支持校验与断点续传。

3.2 延迟监测与反馈 (新)
实时探测：通过心跳包采样 RTT（往返时延），计算滑动平均值。

UI 反馈：

绿色 (< 20ms)：连接极佳。

黄色 (20-50ms)：轻微延迟，建议检查网络。

红色 (> 50ms)：严重延迟，警告用户可能存在操作卡顿。

3.3 系统通知机制 (新)
状态通知：设备连接成功、连接断开、权限缺失提醒。

传输通知：文件传输进度条、传输完成路径提示、传输失败原因。

安全通知：新设备配对请求弹窗。

4. 关键技术点与 UAC 处理策略
4.1 Windows UAC 场景应对
原理：UAC 弹出时系统切换至“安全桌面”，应用层 SendInput 会被权限隔离（UIPI）拦截。

策略：

主动检测：当主控端发送指令无响应且检测到目标机处于高权限界面时，通过 UI 弹出通知。

用户引导：通知内容为“当前处于系统安全界面，请手动操作被控端鼠标点击‘是’”。

非驱动限制声明：明确当前版本不包含内核驱动，无法越权操作 UAC 窗口。

4.2 技术栈选型
模块  推荐方案  理由
开发语言  Rust  内存安全、高性能、跨平台一致性好。
网络层 QUIC (quinn)  内置 TLS 1.3，抗丢包能力强，低延迟。
UI 框架 Tauri / Slint 资源占用极低，符合非商用轻量化需求。
图标资源  Lucide / Heroicons  开源免费，风格统一。

导出到 Google 表格

5. 非功能性需求 (NFR)
安全性：强制 mTLS 双向认证，确保只有配对设备可控制电脑。

交互体验：鼠标跨屏需支持 DPI 缩放补偿，避免因分辨率不同导致的坐标跳变。

资源占用：静默状态下 CPU 占用率应 <1%。

6. 风险清单
UAC 阻塞体验：用户在频繁安装软件时需手动点击，可能产生挫败感。

macOS 权限失效：系统更新可能导致 Accessibility 权限重置，需具备权限自检功能。


跨平台键鼠共享应用需求文档 (PRD)
1. 项目概要
目标：设计并实现一款非商用的跨平台（Windows / macOS）键鼠共享应用。

核心功能：键鼠共享、剪贴板同步、文件拖拽传输、延迟实时监控。

愿景：通过 Rust 与 QUIC 协议提供极低延迟、高安全性的免费开源解决方案。

2. 范围 (Scope)
包含：

Windows (10/11) 与 macOS (Intel/Apple Silicon) 客户端。

基于 QUIC 的加密点对点通信。

实时延迟探测与可视化反馈。

系统级操作通知（连接、传输、错误）。

不包含：Linux 支持、移动端（iOS/Android）、内核级驱动开发（初始阶段）、商业化付费模块。

3. 产品需求 (Functional Requirements)
3.1 核心连接与注入
事件捕获与注入：

Windows：使用 SendInput API 进行事件注入。需识别 UAC 界面状态，当无法注入时及时反馈。

macOS：使用 CGEventPost，需引导用户开启“辅助功能”与“输入监听”权限。

文件传输：仅支持拖拽触发。通过 QUIC 流进行文件分块传输，支持校验与断点续传。

3.2 延迟监测与反馈 (新)
实时探测：通过心跳包采样 RTT（往返时延），计算滑动平均值。

UI 反馈：

绿色 (< 20ms)：连接极佳。

黄色 (20-50ms)：轻微延迟，建议检查网络。

红色 (> 50ms)：严重延迟，警告用户可能存在操作卡顿。

3.3 系统通知机制 (新)
状态通知：设备连接成功、连接断开、权限缺失提醒。

传输通知：文件传输进度条、传输完成路径提示、传输失败原因。

安全通知：新设备配对请求弹窗。

4. 关键技术点与 UAC 处理策略
4.1 Windows UAC 场景应对
原理：UAC 弹出时系统切换至“安全桌面”，应用层 SendInput 会被权限隔离（UIPI）拦截。

策略：

主动检测：当主控端发送指令无响应且检测到目标机处于高权限界面时，通过 UI 弹出通知。

用户引导：通知内容为“当前处于系统安全界面，请手动操作被控端鼠标点击‘是’”。

非驱动限制声明：明确当前版本不包含内核驱动，无法越权操作 UAC 窗口。

4.2 技术栈选型
模块  推荐方案  理由
开发语言  Rust  内存安全、高性能、跨平台一致性好。
网络层 QUIC (quinn)  内置 TLS 1.3，抗丢包能力强，低延迟。
UI 框架 Tauri / Slint 资源占用极低，符合非商用轻量化需求。
图标资源  Lucide / Heroicons  开源免费，风格统一。

导出到 Google 表格

5. 非功能性需求 (NFR)
安全性：强制 mTLS 双向认证，确保只有配对设备可控制电脑。

交互体验：鼠标跨屏需支持 DPI 缩放补偿，避免因分辨率不同导致的坐标跳变。

资源占用：静默状态下 CPU 占用率应 <1%。

6. 风险清单
UAC 阻塞体验：用户在频繁安装软件时需手动点击，可能产生挫败感。

macOS 权限失效：系统更新可能导致 Accessibility 权限重置，需具备权限自检功能。